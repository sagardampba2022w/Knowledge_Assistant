
# Grafana Dashboard SQL Queries for Postgres Table

This `README.md` contains SQL queries that can be used for visualizing data in Grafana. The queries are tailored to work with a PostgreSQL table that stores information about conversation metrics such as response time, relevance, token usage, and API cost.

### Table Overview

| Column Name              | Data Type                       | Description                                                   |
|--------------------------|----------------------------------|---------------------------------------------------------------|
| `id`                     | `TEXT PRIMARY KEY`               | Unique identifier for each conversation                        |
| `question`               | `TEXT`                           | The question asked by the user                                 |
| `answer`                 | `TEXT`                           | The response generated by the model                            |
| `model_used`             | `TEXT`                           | The model utilized to generate the response                    |
| `response_time`          | `FLOAT`                          | The time taken to generate the response (in seconds)           |
| `relevance`              | `TEXT`                           | The relevance rating of the response                           |
| `prompt_tokens`          | `INTEGER`                        | Number of tokens used in the question prompt                   |
| `completion_tokens`      | `INTEGER`                        | Number of tokens used in the model's completion                |
| `total_tokens`           | `INTEGER`                        | Total tokens consumed (prompt + completion)                    |
| `openai_cost`            | `FLOAT`                          | Cost of the OpenAI API call                                    |
| `timestamp`              | `TIMESTAMP WITH TIME ZONE`       | The timestamp when the conversation occurred                   |

---

## SQL Queries for Grafana Dashboards

### 1. **Response Time Tracking**

This query returns the response time of each conversation within the selected date range, helping visualize how quickly the model responds over time.

```sql
SELECT
  timestamp AS time,
  response_time
FROM conversations
WHERE timestamp BETWEEN $__timeFrom() AND $__timeTo()
ORDER BY timestamp
```

### 2. **Relevance Distribution Analysis**

This query counts the occurrences of each relevance level (e.g., "Relevant", "Not Relevant") for conversations in the selected date range, giving insight into the quality of the responses.

```sql
SELECT
  relevance,
  COUNT(*) AS count
FROM conversations
WHERE timestamp BETWEEN $__timeFrom() AND $__timeTo()
GROUP BY relevance
```

### 3. **Model Usage Frequency**

This query shows how often each model is used within a specific time range. This can help analyze the performance and popularity of different models.

```sql
SELECT
  model_used,
  COUNT(*) AS count
FROM conversations
WHERE timestamp BETWEEN $__timeFrom() AND $__timeTo()
GROUP BY model_used
```

### 4. **Token Usage Trends**

This query helps you track the average token consumption (both prompt and completion tokens) over time, grouped by a time interval calculated by Grafana.

```sql
SELECT
  $__timeGroup(timestamp, $__interval) AS time,
  AVG(total_tokens) AS avg_tokens
FROM conversations
WHERE timestamp BETWEEN $__timeFrom() AND $__timeTo()
GROUP BY 1
ORDER BY 1
```

### 5. **OpenAI API Cost Overview**

This query displays the total cost incurred for OpenAI API usage, aggregated over time, to provide an understanding of the financial impact based on usage.

```sql
SELECT
  $__timeGroup(timestamp, $__interval) AS time,
  SUM(openai_cost) AS total_cost
FROM conversations
WHERE timestamp BETWEEN $__timeFrom() AND $__timeTo()
  AND openai_cost > 0
GROUP BY 1
ORDER BY 1
```

### 6. **Recent Conversations Viewer**

This query retrieves the 5 most recent conversations, along with their timestamps, questions, answers, and relevance ratings, providing an overview of the latest interactions.

```sql
SELECT
  timestamp AS time,
  question,
  answer,
  relevance
FROM conversations
WHERE timestamp BETWEEN $__timeFrom() AND $__timeTo()
ORDER BY timestamp DESC
LIMIT 5
```

### 7. **Feedback Analysis**

This query calculates the number of positive and negative feedbacks provided on the conversations, offering insight into user satisfaction.

```sql
SELECT
  SUM(CASE WHEN feedback > 0 THEN 1 ELSE 0 END) AS thumbs_up,
  SUM(CASE WHEN feedback < 0 THEN 1 ELSE 0 END) AS thumbs_down
FROM feedback
WHERE timestamp BETWEEN $__timeFrom() AND $__timeTo()
```

---

## Grafana Special Variables

- **`$__timeFrom()`**: Represents the start of the selected time range in Grafana.
- **`$__timeTo()`**: Represents the end of the selected time range in Grafana.
- **`$__timeGroup(timestamp, $__interval)`**: Automatically groups the results by an interval based on the selected time range.

---

## Instructions

1. **Setting up PostgreSQL Data Source**: Ensure that PostgreSQL is set up as a data source in Grafana.
2. **Implementing Queries**: Copy the SQL queries into Grafana's query editor to create panels for visualizing response times, token usage, costs, and other metrics.
3. **Customizing Queries**: Modify the queries as per your specific data and visualization requirements.

